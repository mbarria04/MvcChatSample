<div id="assistant-chat" class="chat">
@*     <div class="chat-header">
        <span>Asistente</span>
        <button id="chat-toggle" class="chat-toggle" aria-label="Minimizar">–</button>
    </div> *@

    <div id="chat-log" class="chat-log"></div>
    <div class="chat-input">
        <input id="chat-text" type="text" placeholder="Escribe tu pregunta..." />
        <button id="chat-send">Enviar</button>
    </div>
</div>

<link rel="stylesheet" href="~/client-widget/chat-widget.css" />
<script src="~/client-widget/chat-widget.js"></script>

<script>
    (function () {
      const API1_BASE = 'https://localhost:5001'; // <-- AJUSTA según tu Swagger/host real
      const chatEl = document.getElementById('assistant-chat');
      const logEl = document.getElementById('chat-log');
      const inputEl = document.getElementById('chat-text');
      const sendBtn = document.getElementById('chat-send');
      const toggleBtn = document.getElementById('chat-toggle');

      const add = (cls, msg) => {
        const row = document.createElement('div');
        row.className = 'msg ' + cls;

        const bubble = document.createElement('div');
        bubble.className = 'bubble';
        bubble.textContent = msg;

        row.appendChild(bubble);
        logEl.appendChild(row);
        logEl.scrollTop = logEl.scrollHeight;
      };

      const setBusy = (busy) => {
        sendBtn.disabled = busy;
        inputEl.disabled = busy;
        sendBtn.textContent = busy ? 'Enviando…' : 'Enviar';
      };

      async function sendMessage(text) {
        add('user', text);
        setBusy(true);

        try {
          const resp = await fetch(`${API1_BASE}/api/assistant/chat`, {
            method: 'POST',
            headers: { 'Content-Type': 'application/json' },
            body: JSON.stringify({ message: text })
          });

          const contentType = resp.headers.get('content-type') || '';

          // Si la respuesta no es JSON, lee texto (HTML/ vacío) y muestra error amable
          if (!contentType.includes('application/json')) {
            const raw = await resp.text();
            console.error('Respuesta no JSON: status=', resp.status, 'body=', raw);
            add('assistant', `Error HTTP ${resp.status}. Respuesta no JSON.`);
            return;
          }

          const data = await resp.json();

          if (!resp.ok) {
            add('assistant', data?.error ?? `Error HTTP ${resp.status}`);
            return;
          }

          // Tu backend devuelve { reply, context }
          add('assistant', data?.reply ?? '(Respuesta vacía)');
        } catch (e) {
          console.error('Error de red:', e);
          add('assistant', 'Error de red: ' + (e?.message ?? e));
        } finally {
          setBusy(false);
        }
      }

      // Envío por botón y Enter
      const handleSend = () => {
        const txt = (inputEl.value || '').trim();
        if (!txt) return;
        inputEl.value = '';
        sendMessage(txt);
      };

      sendBtn.addEventListener('click', handleSend);
      inputEl.addEventListener('keydown', (e) => {
        if (e.key === 'Enter') handleSend();
      });

      // Minimizar/expandir
      toggleBtn.addEventListener('click', () => {
        const minimized = chatEl.classList.toggle('minimized');
        toggleBtn.textContent = minimized ? '+' : '–';
        toggleBtn.setAttribute('aria-label', minimized ? 'Expandir' : 'Minimizar');
      });
    })();


</script>

