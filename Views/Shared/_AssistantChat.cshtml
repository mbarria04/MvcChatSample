
<div id="assistant-chat" class="chat">
   
    <div id="chat-log" class="chat-log"></div>

    <div class="chat-input">
        <input id="chat-text" type="text" placeholder="Escribe tu pregunta..." autocomplete="off" />
        <button id="chat-send">Enviar</button>
    </div>
</div>

<link rel="stylesheet" href="~/client-widget/chat-widget.css" />

<script>
    (function () {

        const CHAT_ENDPOINT = '/chat/stream';

        const chatEl    = document.getElementById('assistant-chat');
        const logEl     = document.getElementById('chat-log');
        const inputEl   = document.getElementById('chat-text');
        const sendBtn   = document.getElementById('chat-send');
        const toggleBtn = document.getElementById('chat-toggle');

        function addMessage(type, text = '') {
            const row = document.createElement('div');
            row.className = 'msg ' + type;

            const bubble = document.createElement('div');
            bubble.className = 'bubble';
            bubble.textContent = text;

            row.appendChild(bubble);
            logEl.appendChild(row);
            logEl.scrollTop = logEl.scrollHeight;

            return bubble; // 👈 clave para streaming
        }

        function setBusy(busy) {
            sendBtn.disabled = busy;
            inputEl.disabled = busy;
            sendBtn.textContent = busy ? 'Enviando…' : 'Enviar';
        }

        async function sendMessage(text) {
            addMessage('user', text);
            setBusy(true);

            const assistantBubble = addMessage('assistant', '');

            try {
                const resp = await fetch(CHAT_ENDPOINT, {
                    method: 'POST',
                    headers: { 'Content-Type': 'application/json' },
                    body: JSON.stringify({ message: text })
                });

                if (!resp.ok || !resp.body) {
                    assistantBubble.textContent = `❌ Error HTTP ${resp.status}`;
                    return;
                }

                const reader = resp.body.getReader();
                const decoder = new TextDecoder();

                let buffer = '';

                   while (true) {
        const { done, value } = await reader.read();
        if (done) break;

        buffer += decoder.decode(value, { stream: true });

        const events = buffer.split('\n\n');
        buffer = events.pop();

        for (const evt of events) {
            if (!evt.startsWith('data:')) continue;

            // CAMBIO CLAVE: Quitamos "data: " (6 caracteres)
            // ¡SIN USAR .trim()! para no pegar las palabras.
            const data = evt.substring(6);

            if (data.includes('[DONE]')) {
                setBusy(false);
                return;
            }

            // Agregamos el fragmento tal cual viene
            assistantBubble.textContent += data;

            // Auto-scroll
            logEl.scrollTop = logEl.scrollHeight;
        }
    }
            }
            catch (err) {
                assistantBubble.textContent =
                    err.name === 'AbortError'
                        ? '⏳ El asistente tardó demasiado.'
                        : '❌ Error de red.';
            }
            finally {
                setBusy(false);
            }
        }

        function handleSend() {
            const text = inputEl.value.trim();
            if (!text) return;
            inputEl.value = '';
            sendMessage(text);
        }

        sendBtn.addEventListener('click', handleSend);
        inputEl.addEventListener('keydown', e => {
            if (e.key === 'Enter') handleSend();
        });

        toggleBtn.addEventListener('click', () => {
            const minimized = chatEl.classList.toggle('minimized');
            toggleBtn.textContent = minimized ? '+' : '–';
            toggleBtn.setAttribute(
                'aria-label',
                minimized ? 'Expandir' : 'Minimizar'
            );
        });

    })();
</script>
